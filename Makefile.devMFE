# Makefile adaptado para microfrontends + backend + tests E2E

install:
	docker compose run --rm backend sh -c "npm install"
	docker compose run --rm mfe-shell sh -c "npm install"
	docker compose run --rm mfe-login sh -c "npm install"
	docker compose run --rm mfe-dashboard sh -c "npm install"
	docker compose run --rm mfe-dashboard sh -c "npm install --prefix ./e2e playwright && npx playwright install --with-deps"

dev: build install
	docker compose up -d
	docker compose logs -f

build:
	docker compose build

stop:
	docker compose down

restart:
	@echo "🔄 Reiniciando contenedores sin reconstruir..."
	docker compose down
	docker compose up -d
	docker compose logs -f

depack:
	python d.py code      

cleanAll:
	docker compose down -v --remove-orphans
	lsof -t -i tcp:3001 | xargs kill || true
	docker compose down --volumes
	rm -rf node_modules package-lock.json
	docker system prune -af --volumes

# 🚀 Nuevo comando: build + install + up + logs (build limpio)
dev-all:
	@echo "🔄 Construyendo imágenes y reinstalando dependencias..."
	docker compose build --no-cache
	docker compose run --rm backend sh -c "npm install"
	docker compose run --rm mfe-shell sh -c "npm install"
	docker compose run --rm mfe-login sh -c "npm install"
	docker compose run --rm mfe-dashboard sh -c "npm install"
	@echo "🚀 Levantando todos los servicios..."
	docker compose up -d
	@echo "📜 Mostrando logs..."
	docker compose logs -f
	
# ⚡ Arranque rápido sin reconstruir imágenes
start:
	@echo "⚡ Arranque rápido con imágenes ya construidas..."
	docker compose up -d
	docker compose logs -f

# 🧪 Ejecutar tests E2E de Playwright
test-e2e:
	@echo "🧪 Ejecutando tests E2E con Playwright..."
	docker compose run --rm mfe-dashboard sh -c "cd e2e && npx playwright test"

# 🛠️ Ejecutar autoheal y registrar cambios
test-autoheal:
	@echo "🛠️ Ejecutando Autoheal de selectores..."
	docker compose run --rm mfe-dashboard sh -c "node ./autoheal/run_autoheal.js && echo 'Cambios registrados en tests_info.db'"
